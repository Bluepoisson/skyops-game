<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkyOps: Nordic Fleet OCC</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        :root { --bg: #0b0e14; --panel: #1a1f2b; --accent: #00d2ff; --warn: #ff9f43; --danger: #ee5253; --success: #10ac84; --border: #30363d; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-user-select: none; }
        body { background: var(--bg); color: #cfd8dc; margin: 0; overflow: hidden; }

        /* DELAY & DISCRETION COLORS */
        .delay-minor { background: #1e3799 !important; border-left: 4px solid #4a69bd; } 
        .delay-moderate { background: #f39c12 !important; color: #000 !important; } 
        .delay-severe { background: #c0392b !important; animation: pulse-red 2s infinite; }
        .discretion-active { background: repeating-linear-gradient(45deg, #238636, #238636 10px, #f39c12 10px, #f39c12 20px) !important; color: white !important; }

        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* LAYOUT */
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: #161b22; border-bottom: 1px solid var(--border); height: 60px; }
        .stats { display: flex; gap: 15px; align-items: center; font-size: 12px; }
        main { display: grid; grid-template-columns: 1fr 300px; height: calc(100vh - 210px); }
        #occ-grid { display: grid; grid-template-columns: 150px 1fr; overflow-y: auto; background: #0d1117; }
        .tail-column { background: var(--panel); border-right: 1px solid var(--border); position: sticky; left: 0; z-index: 20; }
        .tail-cell { height: 160px; border-bottom: 1px solid var(--border); padding: 10px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        .timeline-scroll { position: relative; overflow-x: auto; background: repeating-linear-gradient(90deg, transparent, transparent 119px, #222 120px); width: 2880px;}
        .hour-markers { display: flex; height: 30px; background: #161b22; width: 2880px; position: sticky; top: 0; z-index: 10; }
        .hour { min-width: 120px; border-right: 1px solid #333; font-size: 10px; line-height: 30px; padding-left: 5px; color: #8b949e; }
        
        .dropzone { height: 160px; border-bottom: 1px solid #222; position: relative; width: 2880px; }
        .flight { position: absolute; height: 60px; top: 20px; background: #238636; border-radius: 4px; color: white; font-size: 10px; padding: 8px; z-index: 5; }
        #time-cursor { position: absolute; top: 0; bottom: 0; width: 2px; background: yellow; z-index: 100; pointer-events: none; box-shadow: 0 0 10px yellow; }

        /* SIDEBAR & CREW */
        aside { background: var(--panel); padding: 15px; border-left: 1px solid var(--border); overflow-y: auto; }
        .crew-item { background: #2c3e50; padding: 8px; margin-bottom: 5px; border-radius: 4px; font-size: 11px; cursor: grab; }
        .fatigue-bar { width: 100%; height: 4px; background: #333; border-radius: 2px; margin-top: 5px; overflow: hidden; }
        .fatigue-fill { height: 100%; background: var(--success); transition: width 0.5s; }

        /* MODALS */
        #manifest-modal { visibility: hidden; opacity: 0; transition: 0.3s; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        #manifest-modal.active { visibility: visible; opacity: 1; }
        .manifest-content { background: var(--panel); border: 2px solid var(--accent); padding: 25px; border-radius: 10px; width: 450px; }

        footer { height: 150px; background: #0d1117; border-top: 2px solid var(--border); overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; }
        .btn { background: #21262d; border: 1px solid var(--border); color: #fff; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 11px; }
    </style>
</head>
<body>

<header>
    <div style="font-weight:800; color:var(--accent)">SKYOPS // <span id="cur-day">MON</span></div>
    <div class="stats">
        <button class="btn" onclick="undoMove()">↺ UNDO</button>
        <span>MORALE: <b id="morale">100%</b></span>
        <span>UTC: <b id="clock">07:00</b></span>
        <span>REV: <b id="rev" style="color:var(--success)">$0</b></span>
    </div>
</header>

<main>
    <div id="occ-grid">
        <div class="tail-column" id="tails"></div>
        <div class="timeline-scroll">
            <div class="hour-markers" id="hours"></div>
            <div id="lanes"><div id="time-cursor"></div></div>
        </div>
    </div>
    <aside id="sidebar-content">
        <div style="font-size:11px; color:var(--accent); margin-bottom:10px;">CREW DISPOSITION</div>
        <div id="crew-pool"></div>
    </aside>
</main>

<div id="manifest-modal" onclick="closeManifest()">
    <div class="manifest-content" onclick="event.stopPropagation()">
        <h2 id="m-tail" style="color:var(--accent); margin:0;"></h2>
        <div id="m-status" style="margin: 10px 0;"></div>
        <div id="m-crew-list" style="font-size:13px; margin-top:15px;"></div>
        <div id="m-action"></div>
        <button class="btn" style="width:100%; margin-top:20px;" onclick="closeManifest()">CLOSE</button>
    </div>
</div>

<footer id="event-log"></footer>

<script>
    // --- STATE ---
    let gameTime = 420; // 07:00
    let revenue = 0;
    let morale = 100;
    let history = [];
    let fleet = Array.from({length: 14}, (_, i) => ({
        id: i, tail: `OY-GM${String.fromCharCode(65+i)}`,
        base: ['CPH', 'BLL', 'ARN', 'HEL'][i % 4],
        pax: 168, discretion: false,
        flights: [],
        crew: [
            { id: Math.random(), name: "Capt. Jensen", role: "CPT", dutyStart: 420, status: "Healthy" },
            { id: Math.random(), name: "FO. Hansen", role: "FO", dutyStart: 420, status: "Healthy" }
        ]
    }));

    let crewPool = Array.from({length: 10}, (_, i) => ({ id: Math.random(), name: "Standby "+i, role: "CCM", dutyStart: null, base: "CPH" }));

    // --- UNDO ---
    function saveState() {
        if(history.length > 20) history.shift();
        history.push(JSON.parse(JSON.stringify({fleet, revenue, morale, gameTime})));
    }
    function undoMove() {
        if(!history.length) return;
        const state = history.pop();
        fleet = state.fleet; revenue = state.revenue; morale = state.morale; gameTime = state.gameTime;
        renderBoard();
    }

    // --- ENGINE ---
    function tick() {
        gameTime++;
        if(gameTime % 240 === 0 && morale < 100) morale++; // Morale recovery
        updateUI();
        if(gameTime % 60 === 0) renderBoard();
    }

    function updateUI() {
        const h = Math.floor(gameTime / 60).toString().padStart(2, '0');
        const m = (gameTime % 60).toString().padStart(2, '0');
        document.getElementById('clock').innerText = `${h}:${m}`;
        document.getElementById('time-cursor').style.left = (gameTime * 2) + 'px';
        document.getElementById('rev').innerText = `$${Math.floor(revenue)}`;
        document.getElementById('morale').innerText = `${morale}%`;
        document.getElementById('morale').style.color = morale < 30 ? 'var(--danger)' : 'var(--success)';
    }

    function renderBoard() {
        const tailsDiv = document.getElementById('tails');
        const lanesDiv = document.getElementById('lanes');
        const poolDiv = document.getElementById('crew-pool');
        
        tailsDiv.innerHTML = ''; 
        lanesDiv.innerHTML = '<div id="time-cursor"></div>';
        poolDiv.innerHTML = '';

        fleet.forEach((ac, idx) => {
            let elapsed = gameTime - 420;
            let fat = Math.min((elapsed / 720) * 100, 100);
            
            tailsDiv.innerHTML += `
                <div class="tail-cell" onclick="openManifest(${idx})">
                    <b style="color:var(--accent)">${ac.tail}</b>
                    <div class="fatigue-bar"><div class="fatigue-fill" style="width:${fat}%; background:${fat > 90 ? 'red' : 'var(--success)'}"></div></div>
                    <small style="margin-top:5px;">${ac.base}</small>
                </div>`;

            const l = document.createElement('div');
            l.className = 'dropzone'; l.dataset.acIdx = idx;
            ac.flights.forEach(f => {
                let delayTag = f.delay > 120 ? 'delay-severe' : (f.delay > 60 ? 'delay-moderate' : (f.delay > 0 ? 'delay-minor' : ''));
                let discretionTag = ac.discretion ? 'discretion-active' : '';
                l.innerHTML += `<div class="flight ${delayTag} ${discretionTag}" id="f-${f.id}" style="width:${f.dur*2}px; left:${f.start*2}px">
                    <b>${f.route}</b>
                </div>`;
            });
            lanesDiv.appendChild(l);
        });

        crewPool.forEach(c => {
            poolDiv.innerHTML += `<div class="crew-item" data-id="${c.id}">${c.role}: ${c.name}</div>`;
        });
        setupDrag();
    }

    // --- MANIFEST & DISCRETION ---
    function openManifest(idx) {
        saveState();
        const ac = fleet[idx];
        const modal = document.getElementById('manifest-modal');
        document.getElementById('m-tail').innerText = ac.tail;
        
        let dutyMins = gameTime - 420;
        let canDiscretion = dutyMins > 720 && dutyMins < 840 && !ac.discretion;

        document.getElementById('m-status').innerHTML = `
            <div>Pax: ${ac.pax}</div>
            <div>Duty Time: ${Math.floor(dutyMins/60)}h ${dutyMins%60}m / 12h</div>
        `;

        document.getElementById('m-crew-list').innerHTML = ac.crew.map(c => `• ${c.name} (${c.role})`).join('<br>');
        
        document.getElementById('m-action').innerHTML = canDiscretion ? `
            <div style="background:rgba(255,159,67,0.1); padding:10px; border:1px solid var(--warn); margin-top:10px;">
                <p style="font-size:11px; margin:0 0 10px 0;">CREW ILLEGAL. Invoke Captain's Discretion (+2h)?</p>
                <button class="btn" style="width:100%; background:var(--warn); color:black;" onclick="invokeDiscretion(${idx})">INVOKE</button>
            </div>
        ` : '';
        
        modal.classList.add('active');
    }

    function invokeDiscretion(idx) {
        const ac = fleet[idx];
        ac.discretion = true;
        revenue -= 5000;
        morale -= 15;
        logEvent('OPS', `DISCRETION: ${ac.tail} extended duty. Morale -15%`, 'warn');
        closeManifest();
        renderBoard();
    }

    function closeManifest() { document.getElementById('manifest-modal').classList.remove('active'); }

    // --- INTERACTIONS ---
    function setupDrag() {
        interact('.flight').draggable({
            listeners: {
                start() { saveState(); },
                move(e) {
                    const t = e.target;
                    const x = (parseFloat(t.getAttribute('data-x')) || 0) + e.dx;
                    const y = (parseFloat(t.getAttribute('data-y')) || 0) + e.dy;
                    t.style.transform = `translate(${x}px, ${y}px)`;
                    t.setAttribute('data-x', x); t.setAttribute('data-y', y);
                },
                end(e) {
                    const dz = document.elementFromPoint(e.clientX, e.clientY)?.closest('.dropzone');
                    if(dz) {
                        const fId = e.target.id.replace('f-','');
                        const targetIdx = dz.dataset.acIdx;
                        moveFlight(fId, targetIdx);
                    }
                    renderBoard();
                }
            }
        });
    }

    function moveFlight(fId, targetIdx) {
        let fObj = null;
        fleet.forEach(ac => {
            const i = ac.flights.findIndex(f => f.id == fId);
            if(i !== -1) fObj = ac.flights.splice(i, 1)[0];
        });
        if(fObj) fleet[targetIdx].flights.push(fObj);
    }

    function logEvent(type, msg, sev) {
        const log = document.getElementById('event-log');
        log.innerHTML = `<div style="border-left:3px solid var(--${sev}); padding-left:5px; margin-bottom:3px;"><b>[${document.getElementById('clock').innerText}] ${type}:</b> ${msg}</div>` + log.innerHTML;
    }

    function generateSchedule() {
        fleet.forEach((ac, idx) => {
            let d = (idx === 0) ? 130 : 0; // Force one severe delay
            ac.flights.push({ id: Math.random(), route: `CPH-LPA`, start: 480 + (idx*10), dur: 240, delay: d });
        });
        renderBoard();
    }

    window.onload = () => {
        for(let i=0; i<24; i++) document.getElementById('hours').innerHTML += `<div class="hour">${i}:00</div>`;
        generateSchedule();
        setInterval(tick, 1000);
    };
</script>
</body>
</html>
