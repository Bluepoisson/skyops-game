<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkyOps: Nordic Fleet OCC</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        :root { --bg: #0b0e14; --panel: #1a1f2b; --accent: #00d2ff; --warn: #ff9f43; --danger: #ee5253; --success: #10ac84; --border: #30363d; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-user-select: none; }
        body { background: var(--bg); color: #cfd8dc; margin: 0; overflow: hidden; }

        /* MODALS & LOADERS */
        #loading-screen, .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader-bar { width: 250px; height: 4px; background: #161b22; border-radius: 10px; margin-top: 20px; overflow: hidden; }
        .loader-progress { width: 0%; height: 100%; background: var(--accent); transition: width 0.3s; }
        .modal { background: rgba(0,0,0,0.9); z-index: 4000; visibility: hidden; opacity: 0; transition: 0.3s; }
        .modal.active { visibility: visible; opacity: 1; }
        .modal-content { background: var(--panel); border: 2px solid var(--accent); padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; }

        /* LAYOUT */
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: #161b22; border-bottom: 1px solid var(--border); height: 60px; }
        main { display: grid; grid-template-columns: 1fr 300px; height: calc(100vh - 210px); }
        #occ-grid { display: grid; grid-template-columns: 140px 1fr; overflow-y: auto; background: #0d1117; }
        .tail-column { background: var(--panel); border-right: 1px solid var(--border); position: sticky; left: 0; z-index: 20; }
        .tail-cell { height: 140px; border-bottom: 1px solid var(--border); padding: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        .timeline-scroll { position: relative; overflow-x: auto; background: repeating-linear-gradient(90deg, transparent, transparent 119px, #222 120px); }
        .hour-markers { display: flex; height: 30px; background: #161b22; width: 2880px; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--border); }
        .hour { min-width: 120px; border-right: 1px solid #333; font-size: 10px; line-height: 30px; padding-left: 5px; color: #8b949e; }
        
        .dropzone { height: 140px; border-bottom: 1px solid #222; position: relative; width: 2880px; }
        #time-cursor { position: absolute; top: 0; bottom: 0; width: 2px; background: yellow; z-index: 100; pointer-events: none; }

        /* FLIGHTS */
        .flight { position: absolute; height: 60px; top: 20px; background: #238636; border-radius: 4px; color: white; font-size: 10px; padding: 8px; z-index: 5; border: 1px solid rgba(255,255,255,0.1); }
        .flight.acmi { background: #1f6feb; border-left: 4px solid var(--accent); }
        .flight.slot-delay { background: var(--warn); color: black; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.6; } }

        /* CREW UI */
        .crew-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 2px; width: 100%; margin-top: 5px; }
        .crew-dot { height: 10px; border-radius: 2px; background: var(--success); }
        .fatigue-bar { width: 100%; height: 3px; background: #333; margin-top: 4px; border-radius: 1px; overflow: hidden; }
        .fatigue-fill { height: 100%; background: var(--success); transition: width 0.5s; }

        /* SIDEBAR & CARDS */
        aside { background: var(--panel); padding: 15px; border-left: 1px solid var(--border); overflow-y: auto; }
        .sidebar-heading { font-size: 11px; color: var(--accent); text-transform: uppercase; margin: 15px 0 10px 0; border-bottom: 1px solid #333; }
        .crew-card, .rest-card { background: #21262d; border: 1px solid var(--border); padding: 8px; margin-bottom: 6px; border-radius: 6px; font-size: 11px; }
        .rest-card { border-color: var(--success); opacity: 0.7; }
        .timer-pill { float: right; color: var(--success); font-weight: bold; }
        
        footer { height: 150px; background: #0d1117; border-top: 2px solid var(--border); overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; }
        .btn { background: #21262d; border: 1px solid var(--border); color: #fff; padding: 6px 10px; cursor: pointer; border-radius: 4px; font-size: 11px; }
    </style>
</head>
<body>

<div id="loading-screen">
    <div style="font-size: 32px; font-weight: 800; color: var(--accent);">SKYOPS</div>
    <div class="loader-bar"><div class="loader-progress" id="load-bar"></div></div>
    <div id="load-tip" style="margin-top:15px; font-size:11px;">SYNCING ROSTERS...</div>
    <button id="start-btn" class="btn" style="display:none; margin-top:20px;" onclick="initTutorial()">START SHIFT</button>
</div>

<div id="tutorial-overlay" class="modal">
    <div class="modal-content">
        <h2 id="tut-title">ðŸ“‹ BRIEFING</h2>
        <p id="tut-text"></p>
        <button class="btn" style="width:100%; background:var(--accent); color:black;" onclick="advanceTutorial()">CONTINUE</button>
    </div>
</div>

<header>
    <div style="font-weight:800; color:var(--accent)">SKYOPS // NORDIC OCC</div>
    <div style="display:flex; gap:20px; font-size:13px;">
        <span>UTC: <b id="clock">07:00</b></span>
        <span>REV: <b id="rev" style="color:var(--success)">$0</b></span>
        <span>OTP: <b id="otp">100%</b></span>
    </div>
</header>

<main>
    <div id="occ-grid">
        <div class="tail-column" id="tails"></div>
        <div class="timeline-scroll">
            <div class="hour-markers" id="hours"></div>
            <div id="lanes">
                <div id="time-cursor"></div>
            </div>
        </div>
    </div>
    <aside>
        <div class="sidebar-heading">Active Scenarios</div>
        <div id="scenario-list"></div>
        <div class="sidebar-heading">Standby Pool</div>
        <div id="reserve-crew"></div>
        <div class="sidebar-heading">Resting Crew</div>
        <div id="resting-crew"></div>
    </aside>
</main>

<footer id="event-log"></footer>

<script>
    // --- STATE & CONFIG ---
    let gameTime = 420; 
    let revenue = 0;
    let dayIndex = 0;
    const days = ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY", "SUNDAY"];
    
    let fleet = Array.from({length: 14}, (_, i) => ({
        id: i,
        tail: `OY-GM${String.fromCharCode(65 + i)}`,
        base: ['CPH', 'BLL', 'ARN', 'HEL'][i % 4],
        hours: Math.random() * 400,
        isSpare: false,
        flights: [],
        assignedCrew: Array.from({length:6}, () => ({ name: "Crew Member", dutyStart: 420 }))
    }));

    let standbyPool = Array.from({length:8}, () => ({ name: "Standby Pilot", role: "CAPT", base: "CPH" }));
    let restingCrew = [];

    // --- LOGIC ---
    function tick() {
        gameTime++;
        const h = Math.floor(gameTime / 60).toString().padStart(2, '0');
        const m = (gameTime % 60).toString().padStart(2, '0');
        document.getElementById('clock').innerText = `${h}:${m}`;
        document.getElementById('time-cursor').style.left = (gameTime * 2) + 'px';

        // Update Resting
        restingCrew.forEach((c, idx) => {
            c.restLeft--;
            if(c.restLeft <= 0) { standbyPool.push(c); restingCrew.splice(idx, 1); }
        });
        
        if(gameTime % 10 === 0) renderBoard();
    }

    function renderBoard() {
        const tailsDiv = document.getElementById('tails');
        const lanesDiv = document.getElementById('lanes');
        const standbyDiv = document.getElementById('reserve-crew');
        const restingDiv = document.getElementById('resting-crew');
        const scenarioDiv = document.getElementById('scenario-list');

        tailsDiv.innerHTML = '';
        lanesDiv.innerHTML = '<div id="time-cursor"></div>';
        
        fleet.forEach((ac, idx) => {
            let duty = gameTime - 420;
            let fatPct = Math.min((duty/720)*100, 100);
            let color = fatPct > 90 ? 'var(--danger)' : (fatPct > 70 ? 'var(--warn)' : 'var(--success)');

            tailsDiv.innerHTML += `
                <div class="tail-cell">
                    <b>${ac.tail}</b>
                    <div class="crew-grid">${Array(6).fill(`<div class="crew-dot" style="background:${color}"></div>`).join('')}</div>
                    <div class="fatigue-bar"><div class="fatigue-fill" style="width:${fatPct}%; background:${color}"></div></div>
                    <small style="font-size:9px; margin-top:5px;">${ac.base} | ${Math.floor(ac.hours)}h</small>
                </div>`;

            const l = document.createElement('div');
            l.className = 'dropzone';
            l.dataset.acIdx = idx;
            ac.flights.forEach(f => {
                l.innerHTML += `<div class="flight ${f.type}" style="width:${f.dur*2}px; left:${f.start*2}px"><b>${f.route}</b></div>`;
            });
            lanesDiv.appendChild(l);
        });

        standbyDiv.innerHTML = standbyPool.map(c => `<div class="crew-card">${c.name} (${c.base})</div>`).join('');
        restingDiv.innerHTML = restingCrew.map(c => `<div class="rest-card">${c.name} <span class="timer-pill">${Math.floor(c.restLeft/60)}h</span></div>`).join('');
        
        scenarioDiv.innerHTML = `
            <button class="btn" style="width:100%; margin-bottom:5px; border-color:var(--danger)" onclick="triggerCrisis('strike')">PILOT STRIKE</button>
            <button class="btn" style="width:100%; border-color:var(--warn)" onclick="triggerCrisis('med')">MEDICAL DIVERSION</button>
        `;
        setupDrag();
    }

    function triggerCrisis(type) {
        if(type === 'strike') {
            alert("STRIKE: 3 Aircraft grounded!");
            fleet[0].flights = []; renderBoard();
        } else {
            alert("MEDICAL: OY-GMA diverting to AMS.");
        }
    }

    // --- INIT ---
    function initTutorial() {
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('tutorial-overlay').classList.add('active');
        document.getElementById('tut-text').innerText = "Welcome Dispatcher. Manage 14 planes. Watch for crew fatigue (the bars below the tails). 12 hours is the limit!";
    }

    function advanceTutorial() {
        document.getElementById('tutorial-overlay').classList.remove('active');
        generateSchedule();
        setInterval(tick, 1000);
    }

    function generateSchedule() {
        fleet.forEach((ac, idx) => {
            let start = 480 + (idx * 20);
            ac.flights.push({ id: Math.random(), route: `${ac.base}-LPA`, start, dur: 240, type: 'charter' });
            ac.flights.push({ id: Math.random(), route: `LPA-${ac.base}`, start: start+300, dur: 240, type: 'charter' });
        });
        renderBoard();
    }

    function setupDrag() {
        interact('.flight').draggable({
            listeners: {
                move(e) {
                    const t = e.target;
                    const x = (parseFloat(t.getAttribute('data-x')) || 0) + e.dx;
                    const y = (parseFloat(t.getAttribute('data-y')) || 0) + e.dy;
                    t.style.transform = `translate(${x}px, ${y}px)`;
                    t.setAttribute('data-x', x); t.setAttribute('data-y', y);
                },
                end(e) { e.target.style.transform = ''; renderBoard(); }
            }
        });
    }

    window.onload = () => {
        let p = 0;
        const iv = setInterval(() => {
            p += 5; document.getElementById('load-bar').style.width = p + '%';
            if(p >= 100) { clearInterval(iv); document.getElementById('start-btn').style.display='block'; }
        }, 100);
        const hr = document.getElementById('hours');
        for(let i=0; i<24; i++) hr.innerHTML += `<div class="hour">${i}:00</div>`;
    };
</script>
</body>
</html>
