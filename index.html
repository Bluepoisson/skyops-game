<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkyOps: Nordic Fleet OCC</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        :root { --bg: #0b0e14; --panel: #1a1f2b; --accent: #00d2ff; --warn: #ff9f43; --danger: #ee5253; --success: #10ac84; --border: #30363d; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-user-select: none; }
        body { background: var(--bg); color: #cfd8dc; margin: 0; overflow: hidden; }

        /* LOADING & TUTORIAL */
        #loading-screen, .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader-bar { width: 250px; height: 4px; background: #161b22; border-radius: 10px; margin-top: 20px; overflow: hidden; }
        .loader-progress { width: 0%; height: 100%; background: var(--accent); box-shadow: 0 0 15px var(--accent); transition: width 0.3s; }
        .modal { background: rgba(0,0,0,0.9); z-index: 4000; visibility: hidden; opacity: 0; transition: 0.3s; }
        .modal.active { visibility: visible; opacity: 1; }
        .modal-content { background: var(--panel); border: 2px solid var(--accent); padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: #161b22; border-bottom: 1px solid var(--border); height: 60px; }
        .stats { display: flex; gap: 20px; font-size: 13px; font-weight: bold; }
        .day-tag { padding: 2px 8px; border-radius: 4px; background: var(--border); font-size: 10px; }

        /* LAYOUT */
        main { display: grid; grid-template-columns: 1fr 300px; height: calc(100vh - 210px); }
        #occ-grid { display: grid; grid-template-columns: 140px 1fr; overflow-y: auto; background: #0d1117; }
        .tail-column { background: var(--panel); border-right: 1px solid var(--border); position: sticky; left: 0; z-index: 20; }
        .tail-cell { height: 130px; border-bottom: 1px solid var(--border); padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; }
        
        .timeline-scroll { position: relative; overflow-x: auto; background: repeating-linear-gradient(90deg, transparent, transparent 119px, #222 120px); }
        .hour-markers { display: flex; height: 30px; background: #161b22; width: 2880px; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--border); }
        .hour { min-width: 120px; border-right: 1px solid #333; font-size: 10px; line-height: 30px; padding-left: 5px; color: #8b949e; }
        
        .dropzone { height: 130px; border-bottom: 1px solid #222; position: relative; width: 2880px; }
        .dropzone.snowing { background: rgba(173, 216, 230, 0.1); }

        /* FLIGHTS */
        .flight { 
            position: absolute; height: 60px; top: 15px; background: #238636; border-radius: 4px; 
            color: white; font-size: 10px; padding: 8px; z-index: 5; border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; justify-content: space-between; overflow: hidden;
        }
        .flight.acmi { background: #1f6feb; border-left: 4px solid var(--accent); }
        .flight.ferry { background: #444; border: 1px dashed #666; }
        .flight.lla-lpa { background: #003366; border-left: 4px solid #fff; } /* Special Long Sector */
        .flight.slot-delay { background: var(--warn); color: #000; animation: blink 1.5s infinite; }
        
        @keyframes blink { 50% { opacity: 0.7; } }

        /* LOG & SIDEBAR */
        aside { background: var(--panel); padding: 15px; border-left: 1px solid var(--border); overflow-y: auto; }
        footer { height: 150px; background: #0d1117; border-top: 2px solid var(--border); overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; }
        .log-entry { margin-bottom: 4px; }
        .log-time { color: var(--accent); margin-right: 8px; }

        .btn { background: #21262d; border: 1px solid var(--border); color: #fff; padding: 8px 12px; cursor: pointer; border-radius: 6px; font-size: 11px; font-weight: bold; }
        .btn:active { transform: scale(0.95); }

        #time-cursor { position: absolute; top: 0; bottom: 0; width: 2px; background: #ffff00; z-index: 100; pointer-events: none; box-shadow: 0 0 10px yellow; }

        /* CREW SLOTS */
        .crew-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; width: 100%; }
        .crew-dot { height: 6px; background: var(--success); border-radius: 1px; }
        .crew-dot.empty { background: var(--danger); }
    </style>
</head>
<body>

<div id="loading-screen">
    <div style="font-size: 32px; font-weight: 800; color: var(--accent); letter-spacing: 2px;">SKYOPS</div>
    <div class="loader-bar"><div class="loader-progress" id="load-bar"></div></div>
    <div id="load-tip" style="margin-top:15px; font-size:11px; color:#8b949e;">CHECKING NOTAMS...</div>
    <button id="start-btn" class="btn" style="display:none; margin-top:20px; padding: 12px 30px;" onclick="initTutorial()">ENTER OCC</button>
</div>

<div id="tutorial-overlay" class="modal">
    <div class="modal-content">
        <h2 id="tut-title" style="margin:0; color:var(--accent);">ðŸ“‹ MORNING BRIEFING</h2>
        <p id="tut-text" style="line-height:1.6; font-size:14px;"></p>
        <button class="btn" style="width:100%; background:var(--accent); color:#000; margin-top:20px;" onclick="advanceTutorial()">CONTINUE</button>
    </div>
</div>

<header>
    <div style="font-weight:800; color:var(--accent); font-size:18px;">SKYOPS // <span id="cur-day-label">MON</span></div>
    <div class="stats">
        <span>UTC: <b id="clock">07:00</b></span>
        <span>REV: <b id="rev" style="color:var(--success)">$0</b></span>
        <span>OTP: <b id="otp" style="color:var(--accent)">100%</b></span>
        <button class="btn" onclick="toggleHangar()">ðŸ”§ HANGAR</button>
    </div>
</header>

<main>
    <div id="occ-grid">
        <div class="tail-column" id="tails"></div>
        <div class="timeline-scroll" id="scroll-area">
            <div class="hour-markers" id="hours"></div>
            <div id="lanes">
                <div id="time-cursor"></div>
            </div>
        </div>
    </div>
    <aside>
        <h3 style="font-size:12px; color:var(--accent); text-transform:uppercase;">ACMI Market (Short-Haul)</h3>
        <div id="market-list"></div>
        <h3 style="font-size:12px; color:var(--warn); text-transform:uppercase; margin-top:30px;">Active Scenarios</h3>
        <div id="scenario-list"></div>
    </aside>
</main>

<footer id="event-log"></footer>

<script>
    /// --- CONFIG & STATE ---
    const CONFIG = { minPx: 2, deiceCost: 1200, slotChance: 0.4 };
    let gameTime = 420; 
    let revenue = 0;
    let dayIndex = 0; 
    const days = ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY", "SUNDAY"];
    
    let fleet = Array.from({length: 14}, (_, i) => ({
        id: i,
        tail: `OY-GM${String.fromCharCode(65 + i)}`,
        base: ['CPH', 'BLL', 'ARN', 'HEL'][i % 4],
        hours: Math.random() * 400,
        isSpare: false,
        status: 'SERVICEABLE',
        flights: []
    }));

    // --- SCENARIO DATA ---
    const scenarios = [
        { id: 'strike', name: "Pilot Strike", desc: "Grounds 3 random planes.", type: 'danger' },
        { id: 'weather', name: "NUK Blizzard", desc: "Heavy de-icing costs.", type: 'warn' },
        { id: 'med', name: "Medical Diversion", desc: "Emergency at AMS.", type: 'danger' }
    ];

    // --- RE-RENDER BOARD (FIXED CREW VISIBILITY) ---
    function renderBoard() {
        const tailsDiv = document.getElementById('tails');
        const lanesDiv = document.getElementById('lanes');
        const scenarioDiv = document.getElementById('scenario-list');
        
        tailsDiv.innerHTML = ''; 
        lanesDiv.innerHTML = '<div id="time-cursor"></div>';
        scenarioDiv.innerHTML = '';

        // 1. Render Scenarios in Sidebar
        scenarios.forEach(s => {
            const sEl = document.createElement('div');
            sEl.className = 'btn';
            sEl.style.display = 'block';
            sEl.style.marginBottom = '5px';
            sEl.style.borderColor = `var(--${s.type})`;
            sEl.innerHTML = `<b>${s.name}</b><br><small>${s.desc}</small>`;
            sEl.onclick = () => activateScenario(s.id);
            scenarioDiv.appendChild(sEl);
        });

        // 2. Render Fleet and Crew
        fleet.forEach((ac, idx) => {
            const t = document.createElement('div');
            t.className = 'tail-cell';
            t.style.height = "130px";
            
            // Create 6 crew dots based on health
            let crewHtml = '<div class="crew-grid">';
            for(let i=0; i<6; i++) {
                crewHtml += `<div class="crew-dot"></div>`;
            }
            crewHtml += '</div>';

            t.innerHTML = `
                <div style="font-weight:bold; color:var(--accent)">${ac.tail}</div>
                ${crewHtml}
                <div style="font-size:9px; color:var(--success)">STAFFED & LEGAL</div>
                <small style="font-size:9px;">${ac.base} | ${Math.floor(ac.hours)}h</small>
                <button class="btn" style="font-size:8px; padding:2px 5px;" onclick="toggleSpare(${idx})">
                    ${ac.isSpare ? 'ACTIVATE' : 'SET SPARE'}
                </button>
            `;
            tailsDiv.appendChild(t);

            const l = document.createElement('div');
            l.className = `dropzone ${ac.isSpare ? 'spare' : ''}`;
            l.dataset.acIdx = idx;
            
            ac.flights.forEach(f => {
                const fEl = document.createElement('div');
                fEl.className = `flight ${f.type} ${f.delayed ? 'slot-delay' : ''}`;
                fEl.id = `f-${f.id}`;
                fEl.style.width = (f.dur * CONFIG.minPx) + 'px';
                fEl.style.left = (f.start * CONFIG.minPx) + 'px';
                fEl.innerHTML = `<b>${f.route}</b><small>${f.type.toUpperCase()}</small>`;
                l.appendChild(fEl);
            });
            lanesDiv.appendChild(l);
        });
        setupDrag();
    }

    // --- SCENARIO LOGIC ---
    function activateScenario(id) {
        play('alert');
        if (id === 'strike') {
            logEvent('CRISIS', "Industrial Action: 3 tails grounded.", 'danger');
            fleet[0].status = 'AOG';
            fleet[1].status = 'AOG';
            fleet[2].status = 'AOG';
        } else if (id === 'med') {
            logEvent('OPS', "Medical Diversion: Diversion to AMS initiated.", 'warn');
            triggerMedical();
        }
        renderBoard();
    }

    // --- RE-SYNC INITIALIZATION ---
    function generateDaySchedule() {
        fleet.forEach(ac => ac.flights = []);
        fleet.forEach((ac, idx) => {
            if (ac.isSpare) return;
            let start = 480 + (idx * 20);
            let f1 = { id: Math.random(), route: `${ac.base}-LPA`, start, dur: 180, type: 'charter', delayed: false };
            let f2 = { id: Math.random(), route: `LPA-${ac.base}`, start: start + 240, dur: 180, type: 'charter', delayed: false };
            ac.flights.push(f1, f2);
        });
        renderBoard();
    }
</script>
</body>
</html>