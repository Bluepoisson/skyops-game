<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkyOps: Nordic Fleet OCC</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        :root { --bg: #0b0e14; --panel: #1a1f2b; --accent: #00d2ff; --warn: #ff9f43; --danger: #ee5253; --success: #10ac84; --border: #30363d; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-user-select: none; }
        body { background: var(--bg); color: #cfd8dc; margin: 0; overflow: hidden; }

        /* LOADING & TUTORIAL */
        #loading-screen, .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader-bar { width: 250px; height: 4px; background: #161b22; border-radius: 10px; margin-top: 20px; overflow: hidden; }
        .loader-progress { width: 0%; height: 100%; background: var(--accent); box-shadow: 0 0 15px var(--accent); transition: width 0.3s; }
        .modal { background: rgba(0,0,0,0.9); z-index: 4000; visibility: hidden; opacity: 0; transition: 0.3s; }
        .modal.active { visibility: visible; opacity: 1; }
        .modal-content { background: var(--panel); border: 2px solid var(--accent); padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: #161b22; border-bottom: 1px solid var(--border); height: 60px; }
        .stats { display: flex; gap: 20px; font-size: 13px; font-weight: bold; }
        .day-tag { padding: 2px 8px; border-radius: 4px; background: var(--border); font-size: 10px; }

        /* LAYOUT */
        main { display: grid; grid-template-columns: 1fr 300px; height: calc(100vh - 210px); }
        #occ-grid { display: grid; grid-template-columns: 140px 1fr; overflow-y: auto; background: #0d1117; }
        .tail-column { background: var(--panel); border-right: 1px solid var(--border); position: sticky; left: 0; z-index: 20; }
        .tail-cell { height: 130px; border-bottom: 1px solid var(--border); padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; }
        
        .timeline-scroll { position: relative; overflow-x: auto; background: repeating-linear-gradient(90deg, transparent, transparent 119px, #222 120px); }
        .hour-markers { display: flex; height: 30px; background: #161b22; width: 2880px; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--border); }
        .hour { min-width: 120px; border-right: 1px solid #333; font-size: 10px; line-height: 30px; padding-left: 5px; color: #8b949e; }
        
        .dropzone { height: 130px; border-bottom: 1px solid #222; position: relative; width: 2880px; }
        .dropzone.snowing { background: rgba(173, 216, 230, 0.1); }

        /* FLIGHTS */
        .flight { 
            position: absolute; height: 60px; top: 15px; background: #238636; border-radius: 4px; 
            color: white; font-size: 10px; padding: 8px; z-index: 5; border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; justify-content: space-between; overflow: hidden;
        }
        .flight.acmi { background: #1f6feb; border-left: 4px solid var(--accent); }
        .flight.ferry { background: #444; border: 1px dashed #666; }
        .flight.lla-lpa { background: #003366; border-left: 4px solid #fff; } /* Special Long Sector */
        .flight.slot-delay { background: var(--warn); color: #000; animation: blink 1.5s infinite; }
        
        @keyframes blink { 50% { opacity: 0.7; } }

        /* LOG & SIDEBAR */
        aside { background: var(--panel); padding: 15px; border-left: 1px solid var(--border); overflow-y: auto; }
        footer { height: 150px; background: #0d1117; border-top: 2px solid var(--border); overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; }
        .log-entry { margin-bottom: 4px; }
        .log-time { color: var(--accent); margin-right: 8px; }

        .btn { background: #21262d; border: 1px solid var(--border); color: #fff; padding: 8px 12px; cursor: pointer; border-radius: 6px; font-size: 11px; font-weight: bold; }
        .btn:active { transform: scale(0.95); }

        #time-cursor { position: absolute; top: 0; bottom: 0; width: 2px; background: #ffff00; z-index: 100; pointer-events: none; box-shadow: 0 0 10px yellow; }

        /* CREW SLOTS */
        .crew-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; width: 100%; }
        .crew-dot { height: 6px; background: var(--success); border-radius: 1px; }
        .crew-dot.empty { background: var(--danger); }
    </style>
</head>
<body>

<div id="loading-screen">
    <div style="font-size: 32px; font-weight: 800; color: var(--accent); letter-spacing: 2px;">SKYOPS</div>
    <div class="loader-bar"><div class="loader-progress" id="load-bar"></div></div>
    <div id="load-tip" style="margin-top:15px; font-size:11px; color:#8b949e;">CHECKING NOTAMS...</div>
    <button id="start-btn" class="btn" style="display:none; margin-top:20px; padding: 12px 30px;" onclick="initTutorial()">ENTER OCC</button>
</div>

<div id="tutorial-overlay" class="modal">
    <div class="modal-content">
        <h2 id="tut-title" style="margin:0; color:var(--accent);">ðŸ“‹ MORNING BRIEFING</h2>
        <p id="tut-text" style="line-height:1.6; font-size:14px;"></p>
        <button class="btn" style="width:100%; background:var(--accent); color:#000; margin-top:20px;" onclick="advanceTutorial()">CONTINUE</button>
    </div>
</div>

<header>
    <div style="font-weight:800; color:var(--accent); font-size:18px;">SKYOPS // <span id="cur-day-label">MON</span></div>
    <div class="stats">
        <span>UTC: <b id="clock">07:00</b></span>
        <span>REV: <b id="rev" style="color:var(--success)">$0</b></span>
        <span>OTP: <b id="otp" style="color:var(--accent)">100%</b></span>
        <button class="btn" onclick="toggleHangar()">ðŸ”§ HANGAR</button>
    </div>
</header>

<main>
    <div id="occ-grid">
        <div class="tail-column" id="tails"></div>
        <div class="timeline-scroll" id="scroll-area">
            <div class="hour-markers" id="hours"></div>
            <div id="lanes">
                <div id="time-cursor"></div>
            </div>
        </div>
    </div>
    <aside>
        <h3 style="font-size:12px; color:var(--accent); text-transform:uppercase;">ACMI Market (Short-Haul)</h3>
        <div id="market-list"></div>
        <h3 style="font-size:12px; color:var(--warn); text-transform:uppercase; margin-top:30px;">Active Scenarios</h3>
        <div id="scenario-list"></div>
    </aside>
</main>

<footer id="event-log"></footer>

<script>
    // --- CONFIG & STATE ---
    const CONFIG = { minPx: 2, deiceCost: 1200, slotChance: 0.4 };
    let gameTime = 420; // 07:00
    let revenue = 0;
    let dayIndex = 0; // 0=Mon, 1=Tue...
    const days = ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY", "SUNDAY"];
    
    let fleet = Array.from({length: 14}, (_, i) => ({
        id: i,
        tail: `OY-GM${String.fromCharCode(65 + i)}`,
        base: ['CPH', 'BLL', 'ARN', 'HEL'][i % 4],
        hours: Math.random() * 400,
        isSpare: false,
        flights: []
    }));

    // --- SOUND ENGINE ---
    const sfx = {
        telex: new Audio('https://actions.google.com/sounds/v1/office/typing_fast.ogg'),
        alert: new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg'),
        radio: new Audio('https://actions.google.com/sounds/v1/science_fiction/radio_static.ogg')
    };
    function play(key) { sfx[key].currentTime = 0; sfx[key].volume = 0.2; sfx[key].play().catch(()=>{}); }

    // --- SCHEDULE GENERATOR ---
    function generateDaySchedule() {
        fleet.forEach(ac => ac.flights = []);
        const isMidWeek = (dayIndex === 1 || dayIndex === 2); // Tue/Wed Dip
        
        fleet.forEach((ac, idx) => {
            if (ac.isSpare) return;
            
            // Standard Charters
            if (!isMidWeek || idx < 7) {
                let dest = ac.base === 'LLA' ? 'LPA' : (idx % 2 === 0 ? 'LPA' : 'PMI');
                let start = 480 + (idx * 15);
                let dur = (ac.base === 'LLA' && dest === 'LPA') ? 360 : 180;
                
                let f1 = { id: Math.random(), route: `${ac.base}-${dest}`, start, dur, type: dest==='LPA'&&ac.base==='LLA'?'lla-lpa':'charter', delayed: false };
                let f2 = { id: Math.random(), route: `${dest}-${ac.base}`, start: start + dur + 50, dur, type: 'charter', delayed: false };
                ac.flights.push(f1, f2);
            }
        });
        renderBoard();
    }

    // --- UI ENGINE ---
    function renderBoard() {
        const tailsDiv = document.getElementById('tails');
        const lanesDiv = document.getElementById('lanes');
        tailsDiv.innerHTML = ''; 
        const cursor = document.getElementById('time-cursor');
        lanesDiv.innerHTML = '';
        lanesDiv.appendChild(cursor);

        fleet.forEach((ac, idx) => {
            const t = document.createElement('div');
            t.className = 'tail-cell';
            t.innerHTML = `
                <div style="font-weight:bold; color:var(--accent)">${ac.tail}</div>
                <div class="crew-grid">${Array(6).fill('<div class="crew-dot"></div>').join('')}</div>
                <small style="font-size:9px;">BASE: ${ac.base} | ${Math.floor(ac.hours)}h</small>
                <button class="btn" style="font-size:8px; padding:2px 5px;" onclick="toggleSpare(${idx})">${ac.isSpare?'ACTIVATE':'SET SPARE'}</button>
            `;
            tailsDiv.appendChild(t);

            const l = document.createElement('div');
            l.className = `dropzone ${ac.isSpare ? 'spare' : ''}`;
            l.dataset.acIdx = idx;
            
            ac.flights.forEach(f => {
                const fEl = document.createElement('div');
                fEl.className = `flight ${f.type} ${f.delayed ? 'slot-delay' : ''}`;
                fEl.id = `f-${f.id}`;
                fEl.style.width = (f.dur * CONFIG.minPx) + 'px';
                fEl.style.left = (f.start * CONFIG.minPx) + 'px';
                fEl.innerHTML = `<b>${f.route}</b><small>${f.type.toUpperCase()}</small>`;
                l.appendChild(fEl);
            });
            lanesDiv.appendChild(l);
        });
        setupDrag();
    }

    function logEvent(type, msg, sev = '') {
        const log = document.getElementById('event-log');
        const time = document.getElementById('clock').innerText;
        log.innerHTML = `<div class="log-entry ${sev}"><span class="log-time">[${time}]</span><b>${type}</b>: ${msg}</div>` + log.innerHTML;
        play('telex');
    }

    // --- INTERACTION ---
    function setupDrag() {
        interact('.flight').draggable({
            listeners: {
                move(event) {
                    const target = event.target;
                    const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                    const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
                    target.style.transform = `translate(${x}px, ${y}px)`;
                    target.setAttribute('data-x', x);
                    target.setAttribute('data-y', y);
                    target.style.zIndex = 1000;
                },
                end(event) {
                    const flightEl = event.target;
                    const dropzone = document.elementFromPoint(event.clientX, event.clientY)?.closest('.dropzone');
                    if (dropzone) {
                        const newIdx = dropzone.dataset.acIdx;
                        const fId = flightEl.id.replace('f-', '');
                        executeSwap(fId, newIdx);
                    }
                    flightEl.style.transform = 'none';
                    flightEl.setAttribute('data-x', 0);
                    flightEl.setAttribute('data-y', 0);
                    renderBoard();
                }
            }
        });
    }

    function executeSwap(fId, targetIdx) {
        let fObj = null;
        fleet.forEach(ac => {
            const i = ac.flights.findIndex(f => f.id == fId);
            if(i !== -1) fObj = ac.flights.splice(i, 1)[0];
        });
        if(fObj) {
            fleet[targetIdx].flights.push(fObj);
            logEvent('SWAP', `Tail Swap: ${fObj.route} moved to ${fleet[targetIdx].tail}`);
        }
    }

    function toggleSpare(idx) {
        fleet[idx].isSpare = !fleet[idx].isSpare;
        logEvent('FLEET', `${fleet[idx].tail} status changed.`);
        renderBoard();
    }

    // --- GAME LOOP ---
    function tick() {
        gameTime += 1; // 1 sec = 1 min
        if (gameTime >= 1440) {
            gameTime = 0;
            dayIndex = (dayIndex + 1) % 7;
            document.getElementById('cur-day-label').innerText = days[dayIndex].substring(0,3);
            generateDaySchedule();
            logEvent('SYSTEM', `Day transition to ${days[dayIndex]}`);
        }

        const h = Math.floor(gameTime / 60).toString().padStart(2, '0');
        const m = (gameTime % 60).toString().padStart(2, '0');
        document.getElementById('clock').innerText = `${h}:${m}`;
        document.getElementById('time-cursor').style.left = (gameTime * CONFIG.minPx) + 'px';

        // Random Crisis Engine
        if (Math.random() < 0.0004) triggerMedical();
        if (Math.random() < 0.0002) triggerSickCall();
    }

    function triggerMedical() {
        play('alert');
        logEvent('CRITICAL', 'Medical Diversion! OY-GMC diverting to AMS.', 'danger');
        // Simple Logic: Add a tech delay to a random flight
        const ac = fleet[Math.floor(Math.random()*14)];
        if(ac.flights[0]) { ac.flights[0].delayed = true; ac.flights[0].dur += 60; renderBoard(); }
    }

    function triggerSickCall() {
        play('radio');
        logEvent('CREW', 'Sick call on homebound LPA-CPH sling. Recovery needed.', 'warn');
    }

    // --- TUTORIAL ---
    const tutSteps = [
        "Welcome to the CPH Ops Center. You are the Duty Manager for 14 Boeing 737-800s.",
        "Your core business is Sun Charters (LPA, TFS, PMI). On Tuesdays and Wednesdays, volume dropsâ€”use this for maintenance.",
        "Watch out for the LLA-LPA flight. It is a 6-hour monster. Any delay means the crew will time out.",
        "Drag flights to different planes if one breaks. Keep the Spare plane ready for emergencies. Good luck."
    ];
    let step = 0;
    function initTutorial() {
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('tutorial-overlay').classList.add('active');
        document.getElementById('tut-text').innerText = tutSteps[0];
    }
    function advanceTutorial() {
        step++;
        if(step < tutSteps.length) {
            document.getElementById('tut-text').innerText = tutSteps[step];
        } else {
            document.getElementById('tutorial-overlay').classList.remove('active');
            generateDaySchedule();
            setInterval(tick, 1000);
        }
    }

    // --- LOADER ---
    window.onload = () => {
        let p = 0;
        const iv = setInterval(() => {
            p += Math.random() * 20;
            if(p >= 100) { p=100; clearInterval(iv); document.getElementById('start-btn').style.display='block'; }
            document.getElementById('load-bar').style.width = p + '%';
        }, 200);
    };
</script>
</body>
</html>