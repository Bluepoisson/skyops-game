<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkyOps: Nordic Fleet OCC</title>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        :root { --bg: #0b0e14; --panel: #1a1f2b; --accent: #00d2ff; --warn: #ff9f43; --danger: #ee5253; --success: #10ac84; --border: #30363d; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: #cfd8dc; margin: 0; overflow: hidden; }

        /* HEADER & UI */
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: #161b22; border-bottom: 1px solid var(--border); height: 60px; }
        .stat-bar { display: flex; gap: 20px; align-items: center; }
        .btn { background: #21262d; border: 1px solid var(--border); color: #c9d1d9; padding: 8px 12px; cursor: pointer; border-radius: 6px; font-size: 12px; }
        .btn:hover { background: #30363d; border-color: var(--accent); }
        .btn.danger { color: var(--danger); }

        /* LAYOUT */
        main { display: grid; grid-template-columns: 1fr 320px; height: calc(100vh - 210px); }
        
        /* GANTT CHART */
        #occ-grid { display: grid; grid-template-columns: 120px 1fr; overflow-y: auto; background: #0d1117; }
        .tail-column { background: var(--panel); border-right: 1px solid var(--border); position: sticky; left: 0; z-index: 20; }
        .tail-cell { height: 120px; border-bottom: 1px solid var(--border); padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; position: relative; }
        .spare-badge { position: absolute; top: 5px; right: 5px; font-size: 10px; color: var(--warn); border: 1px solid var(--warn); padding: 1px 3px; border-radius: 3px; }

        .timeline-scroll { position: relative; overflow-x: auto; overflow-y: hidden; background: repeating-linear-gradient(90deg, transparent, transparent 119px, #222 120px); }
        .hour-markers { display: flex; height: 30px; background: #161b22; width: 2880px; position: sticky; top: 0; z-index: 10; }
        .hour { min-width: 120px; border-right: 1px solid #333; font-size: 10px; line-height: 30px; padding-left: 5px; }
        
        .dropzone { height: 120px; border-bottom: 1px solid #222; position: relative; width: 2880px; }
        .dropzone.drag-target { background: rgba(0, 210, 255, 0.05); }

        /* FLIGHT BLOCKS */
        .flight { 
            position: absolute; height: 50px; top: 10px; background: #238636; 
            border-radius: 4px; color: white; font-size: 10px; padding: 8px; 
            cursor: move; touch-action: none; z-index: 5; border: 1px solid rgba(255,255,255,0.1);
        }
        .flight.ferry { background: #444; border-style: dashed; }
        .flight.acmi { background: #1f6feb; border-left: 4px solid var(--accent); }
        .flight.slot-delay { background: var(--warn); color: black; border-left: 4px solid #000; }

        /* CREW SLOTS */
        .crew-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; width: 100%; margin-top: 5px; }
        .crew-slot { height: 20px; background: #000; border-radius: 2px; font-size: 8px; text-align: center; line-height: 20px; color: #555; }
        .crew-slot.filled { color: var(--success); background: #1a2f1a; border: 1px solid var(--success); }

        /* LOG FOOTER */
        footer { height: 150px; background: #0d1117; border-top: 2px solid var(--border); overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; }
        .log-entry { margin-bottom: 4px; display: flex; gap: 10px; }
        .log-time { color: #8b949e; }
        .danger { color: var(--danger); }
        .warn { color: var(--warn); }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; visibility: hidden; }
        .modal.active { visibility: visible; }
        .modal-content { background: var(--panel); border: 2px solid var(--accent); padding: 30px; border-radius: 12px; width: 400px; text-align: center; }

        #time-cursor { position: absolute; top: 0; bottom: 0; width: 2px; background: yellow; z-index: 10; pointer-events: none; }
    </style>
</head>
<body>

<header>
    <div style="font-weight:800; color:var(--accent)">SKYOPS // NORDIC OCC</div>
    <div class="stat-bar">
        <span>UTC: <b id="clock">08:00</b></span>
        <span>REV: <b id="rev" style="color:var(--success)">$0</b></span>
        <span>OTP: <b id="otp">100%</b></span>
        <button class="btn" onclick="toggleHangar()">ðŸ”§ HANGAR</button>
        <button class="btn btn-save" onclick="saveGame()">SYNC</button>
    </div>
</header>

<main>
    <div id="occ-grid">
        <div class="tail-column" id="tails"></div>
        <div class="timeline-scroll" id="scroll-area">
            <div class="hour-markers" id="hours"></div>
            <div id="lanes"></div>
            <div id="time-cursor"></div>
        </div>
    </div>

    <aside class="sidebar" style="background:var(--panel); border-left:1px solid var(--border); padding:15px; overflow-y:auto;">
        <h3 style="font-size:12px; color:var(--accent)">ACMI MARKET</h3>
        <div id="market-list"></div>
        <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
        <h3 style="font-size:12px; color:var(--warn)">RESERVE CREW</h3>
        <div id="reserve-crew"></div>
    </aside>
</main>

<footer id="event-log-entries"></footer>

<div id="atc-modal" class="modal">
    <div class="modal-content">
        <h3>ðŸ“¡ EUROCONTROL: SLOT ISSUED</h3>
        <p id="atc-msg">Flight blocked by CTOT penalty.</p>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button class="btn" onclick="negotiate('ready')">SEND READY MSG (60% Success)</button>
            <button class="btn" onclick="negotiate('force')">EXEMPTION REQUEST (20% Success)</button>
        </div>
    </div>
</div>

<script>
    // --- STATE ---
    let gameTime = 480;
    let revenue = 0;
    let totalFlights = 0;
    let delayedFlights = 0;
    const pxPerMin = 2;

    const SFX = {
        CHIME: 'https://actions.google.com/sounds/v1/alarms/beep_short.ogg',
        TELEX: 'https://actions.google.com/sounds/v1/office/typing_fast.ogg',
        DANGER: 'https://actions.google.com/sounds/v1/alarms/alarm_clock_beeping.ogg'
    };

    let fleet = Array.from({length: 14}, (_, i) => ({
        id: i,
        tail: `OY-GM${String.fromCharCode(65 + i)}`,
        base: ['CPH', 'BLL', 'ARN', 'HEL'][i % 4],
        hours: Math.random() * 400,
        isSpare: false,
        flights: []
    }));

    // --- SOUND ENGINE ---
    function playSound(url) {
        const a = new Audio(url);
        a.volume = 0.3;
        a.play().catch(() => {});
    }

    // --- CORE LOGIC ---
    function tick() {
        gameTime++;
        if(gameTime >= 1440) {
            gameTime = 0;
            fleet.forEach(ac => ac.hours += 10); // End of day wear
        }

        const h = Math.floor(gameTime / 60).toString().padStart(2,'0');
        const m = (gameTime % 60).toString().padStart(2,'0');
        document.getElementById('clock').innerText = `${h}:${m}`;
        document.getElementById('time-cursor').style.left = (gameTime * pxPerMin) + 'px';
        
        // Random Events
        if(Math.random() < 0.0005) triggerSickCall();
        if(Math.random() < 0.0003) logEvent('TECH', 'Ground Incident reported at ARN', 'warn');
    }

    function logEvent(type, msg, severity = 'info') {
        const log = document.getElementById('event-log-entries');
        const time = document.getElementById('clock').innerText;
        log.innerHTML = `<div class="log-entry ${severity}"><span class="log-time">[${time}]</span> <b>${type}:</b> ${msg}</div>` + log.innerHTML;
        playSound(SFX.TELEX);
    }

    function renderBoard() {
        const tailsDiv = document.getElementById('tails');
        const lanesDiv = document.getElementById('lanes');
        tailsDiv.innerHTML = ''; lanesDiv.innerHTML = '';

        fleet.forEach((ac, idx) => {
            // Render Tail
            const t = document.createElement('div');
            t.className = 'tail-cell';
            t.innerHTML = `
                ${ac.isSpare ? '<span class="spare-badge">SPARE</span>' : ''}
                <b>${ac.tail}</b>
                <div class="crew-container">
                    ${Array(6).fill('<div class="crew-slot filled"></div>').join('')}
                </div>
                <small style="font-size:9px">${ac.base} | ${Math.floor(ac.hours)}h</small>
            `;
            t.onclick = () => { ac.isSpare = !ac.isSpare; renderBoard(); };
            tailsDiv.appendChild(t);

            // Render Lane
            const l = document.createElement('div');
            l.className = 'dropzone';
            l.dataset.acIdx = idx;
            
            ac.flights.forEach(f => {
                const fEl = document.createElement('div');
                fEl.className = `flight ${f.type} ${f.delayed ? 'slot-delay' : ''}`;
                fEl.id = `f-${f.id}`;
                fEl.style.width = (f.dur * pxPerMin) + 'px';
                fEl.style.left = (f.start * pxPerMin) + 'px';
                fEl.innerHTML = `<b>${f.route}</b><br>${f.type.toUpperCase()}`;
                l.appendChild(fEl);
            });
            lanesDiv.appendChild(l);
        });
        updateStats();
    }

    // --- SWAP ENGINE ---
    interact('.flight').draggable({
        listeners: {
            move(event) {
                const target = event.target;
                const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
                target.style.transform = `translate(${x}px, ${y}px)`;
                target.setAttribute('data-x', x);
                target.setAttribute('data-y', y);
                target.style.zIndex = 1000;
            },
            end(event) {
                const flightEl = event.target;
                const dropzone = document.elementFromPoint(event.clientX, event.clientY)?.closest('.dropzone');
                
                if (dropzone) {
                    const newAcIdx = parseInt(dropzone.dataset.acIdx);
                    const flightId = parseInt(flightEl.id.replace('f-', ''));
                    executeSwap(flightId, newAcIdx);
                }
                flightEl.style.transform = 'none';
                flightEl.setAttribute('data-x', 0);
                flightEl.setAttribute('data-y', 0);
                renderBoard();
            }
        }
    });

    function executeSwap(flightId, targetIdx) {
        let flightObj = null;
        fleet.forEach(ac => {
            const idx = ac.flights.findIndex(f => f.id === flightId);
            if(idx !== -1) flightObj = ac.flights.splice(idx, 1)[0];
        });
        if(flightObj) {
            fleet[targetIdx].flights.push(flightObj);
            logEvent('SWAP', `Flight ${flightObj.route} moved to ${fleet[targetIdx].tail}`);
        }
    }

    // --- MARKET & OPS ---
    function updateMarket() {
        const list = document.getElementById('market-list');
        const jobs = [
            { r: 'CPH-ARN', p: 8500, b: 'CPH' },
            { r: 'HEL-OSL', p: 9200, b: 'HEL' },
            { r: 'BLL-STN', p: 7800, b: 'BLL' }
        ];
        list.innerHTML = jobs.map(j => `
            <div style="background:#21262d; padding:10px; margin-bottom:5px; border-radius:4px; font-size:11px;">
                <b>${j.r}</b> <span style="color:var(--success)">$${j.p}</span>
                <button class="btn" style="width:100%; margin-top:5px" onclick="bookJob('${j.r}', ${j.p}, '${j.b}')">BOOK</button>
            </div>
        `).join('');
    }

    function bookJob(route, pay, base) {
        const ac = fleet.find(a => a.base === base && !a.isSpare);
        if(!ac) { logEvent('OPS', `No active aircraft at ${base}`, 'danger'); return; }
        
        const start = gameTime + 60;
        const outbound = { id: Date.now(), route, start, dur: 90, type: 'acmi', delayed: false };
        const inbound = { id: Date.now()+1, route: route.split('-').reverse().join('-'), start: start + 135, dur: 90, type: 'ferry', delayed: false };
        
        ac.flights.push(outbound, inbound);
        revenue += pay;
        totalFlights += 1;
        renderBoard();
        playSound(SFX.CHIME);
    }

    function triggerSickCall() {
        logEvent('CREW', 'SICK CALL: Pilot reported unfit at CPH', 'danger');
        playSound(SFX.DANGER);
        // Randomly delay a CPH flight
        fleet.forEach(ac => {
            if(ac.base === 'CPH' && ac.flights.length > 0) {
                ac.flights[0].delayed = true;
                ac.flights[0].start += 45;
                delayedFlights++;
            }
        });
        renderBoard();
    }

    function updateStats() {
        const otp = totalFlights === 0 ? 100 : Math.floor(((totalFlights - delayedFlights) / totalFlights) * 100);
        document.getElementById('otp').innerText = otp + '%';
        document.getElementById('rev').innerText = `$${revenue.toLocaleString()}`;
        if(otp < 50) logEvent('CRITICAL', 'Reputation failing! License at risk.', 'danger');
    }

    function saveGame() {
        localStorage.setItem('SkyOps_Pro_Save', JSON.stringify({fleet, revenue, gameTime}));
        logEvent('SYSTEM', 'Cloud Sync Complete');
    }

    // --- INIT ---
    const hourRow = document.getElementById('hours');
    for(let i=0; i<24; i++) {
        const h = document.createElement('div');
        h.className = 'hour';
        h.innerText = `${i.toString().padStart(2,'0')}:00`;
        hourRow.appendChild(h);
    }

    setInterval(tick, 1000);
    setInterval(updateMarket, 10000);
    renderBoard();
    updateMarket();
</script>

</body>
</html>