<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkyOps: Nordic Fleet OCC & PPS</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        :root { --bg: #0b0e14; --panel: #1a1f2b; --accent: #00d2ff; --warn: #ff9f43; --danger: #ee5253; --success: #10ac84; --border: #30363d; --pdc-bg: #f1f5f9; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-user-select: none; }
        body { background: var(--bg); color: #cfd8dc; margin: 0; overflow: hidden; }

        /* NAVIGATION */
        nav { display: flex; background: #161b22; border-bottom: 1px solid var(--border); height: 45px; }
        .tab-btn { background: transparent; border: none; color: #8b949e; padding: 0 25px; cursor: pointer; font-size: 12px; font-weight: bold; border-right: 1px solid var(--border); }
        .tab-btn.active { background: var(--panel); color: var(--accent); border-bottom: 3px solid var(--accent); }

        /* OCC VIEW */
        .view-pane { display: none; height: calc(100vh - 45px); }
        .view-pane.active { display: grid; }
        #view-occ { grid-template-columns: 1fr 300px; }
        #occ-grid { display: grid; grid-template-columns: 150px 1fr; overflow-y: auto; background: #0d1117; }
        .tail-column { background: var(--panel); border-right: 1px solid var(--border); position: sticky; left: 0; z-index: 20; }
        .tail-cell { height: 160px; border-bottom: 1px solid var(--border); padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .timeline-scroll { position: relative; overflow-x: auto; background: repeating-linear-gradient(90deg, transparent, transparent 119px, #222 120px); width: 2880px; }
        .hour-markers { display: flex; height: 30px; background: #161b22; width: 2880px; position: sticky; top: 0; z-index: 10; }
        .hour { min-width: 120px; border-right: 1px solid #333; font-size: 10px; line-height: 30px; padding-left: 5px; color: #8b949e; }
        .dropzone { height: 160px; border-bottom: 1px solid #222; position: relative; width: 2880px; }
        .flight { position: absolute; height: 60px; top: 20px; background: #238636; border-radius: 4px; color: white; font-size: 10px; padding: 8px; z-index: 5; transition: top 0.3s; }
        #time-cursor { position: absolute; top: 0; bottom: 0; width: 2px; background: yellow; z-index: 100; pointer-events: none; box-shadow: 0 0 10px yellow; }

        /* SLOT & DELAY CLASSES */
        .delay-severe { background: #c0392b !important; }
        .slot-delayed { border: 2px solid #ff7f50; box-shadow: 0 0 8px rgba(255, 127, 80, 0.5); }
        .slot-badge { position: absolute; bottom: -8px; left: 5px; background: #ff7f50; color: #000; font-size: 8px; padding: 1px 4px; border-radius: 2px; font-weight: bold; }

        /* PPS TERMINAL */
        .pps-msg { font-family: 'Courier New', monospace; font-size: 10px; color: #10ac84; background: #000; padding: 12px; margin: 10px 0; border-radius: 4px; border: 1px solid #333; line-height: 1.4; }

        /* MODALS */
        #manifest-modal { visibility: hidden; opacity: 0; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:999; display:flex; align-items:center; justify-content:center; }
        #manifest-modal.active { visibility: visible; opacity: 1; }
        .m-content { background: var(--panel); color: white; padding: 25px; border-radius: 8px; width: 450px; border: 1px solid var(--accent); }
        
        .btn { background: #21262d; border: 1px solid var(--border); color: #fff; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-size: 11px; }
        footer { height: 150px; background: #0d1117; border-top: 1px solid var(--border); overflow-y: auto; padding: 10px; font-size: 11px; }
    </style>
</head>
<body>

<nav>
    <button class="tab-btn active" id="btn-occ" onclick="switchTab('occ')">‚úàÔ∏è OPS CONTROL</button>
    <button class="tab-btn" id="btn-pdc" onclick="switchTab('pdc')">üë• CREW MGMT (PDC)</button>
    <div style="margin-left:auto; display:flex; align-items:center; padding-right:15px; gap:20px; font-size:11px; color:var(--accent);">
        <span>UTC: <b id="clock">07:00</b></span>
        <span>REV: <b id="rev">0</b> DKK</span>
    </div>
</nav>

<div id="view-occ" class="view-pane active">
    <div id="occ-grid">
        <div class="tail-column" id="tails"></div>
        <div class="timeline-scroll">
            <div class="hour-markers" id="hours"></div>
            <div id="lanes"><div id="time-cursor"></div></div>
        </div>
    </div>
    <aside>
        <button class="btn" style="width:100%; border-color:var(--warn);" onclick="undoMove()">‚Ü∫ UNDO ACTION</button>
        <div style="margin-top:20px; font-size:11px; color:var(--warn); border-bottom:1px solid #333; padding-bottom:5px;">SLOT STATUS (PPS)</div>
        <div id="slot-list" style="font-size:10px; margin-top:10px;"></div>
    </aside>
</div>

<div id="view-pdc" class="view-pane"></div>

<div id="manifest-modal" onclick="closeManifest()">
    <div class="m-content" onclick="event.stopPropagation()">
        <h2 id="m-tail" style="margin:0; font-size:18px; color:var(--accent);"></h2>
        <div id="m-data"></div>
        <div id="m-action"></div>
        <button class="btn" style="width:100%; margin-top:15px;" onclick="closeManifest()">CLOSE</button>
    </div>
</div>

<footer id="event-log"></footer>

<script>
    let gameTime = 420; 
    let revenue = 10000000;
    let history = [];
    let fleet = Array.from({length: 14}, (_, i) => ({
        id: i, tail: `OY-GM${String.fromCharCode(65+i)}`,
        base: ['CPH', 'BLL', 'ARN', 'HEL'][i % 4],
        pax: 189, discretion: false, flights: []
    }));

    // --- ENGINE ---
    function tick() {
        gameTime++;
        const h = Math.floor(gameTime / 60).toString().padStart(2, '0');
        const m = (gameTime % 60).toString().padStart(2, '0');
        document.getElementById('clock').innerText = `${h}:${m}`;
        document.getElementById('time-cursor').style.left = (gameTime * 2) + 'px';
        document.getElementById('rev').innerText = revenue.toLocaleString();

        // Slot Expiry Logic
        fleet.forEach(ac => {
            ac.flights.forEach(f => {
                if (f.slot && !f.ready && gameTime > (f.slot.ctot - 15) && gameTime < f.slot.ctot) {
                    logEvent('ATC', `SLOT EXPIRED: ${f.route} was not Ready 15m prior to CTOT.`, 'danger');
                    f.delay += 45; f.slot.ctot += 45;
                }
            });
        });

        if(gameTime % 20 === 0) renderOCC();
    }

    // --- OCC & SLOT LOGIC ---
    function renderOCC() {
        const tails = document.getElementById('tails');
        const lanes = document.getElementById('lanes');
        tails.innerHTML = ''; 
        lanes.innerHTML = '<div id="time-cursor"></div>';

        fleet.forEach((ac, idx) => {
            tails.innerHTML += `<div class="tail-cell" onclick="openManifest(${idx})">
                <b>${ac.tail}</b><small>${ac.base}</small>
            </div>`;
            const l = document.createElement('div');
            l.className = 'dropzone'; l.dataset.idx = idx;
            ac.flights.forEach(f => {
                let slotBadge = f.slot ? `<div class="slot-badge">CTOT ${formatMins(f.slot.ctot)}</div>` : '';
                let slotClass = f.slot ? 'slot-delayed' : '';
                let dClass = f.delay > 180 ? 'delay-severe' : '';
                
                l.innerHTML += `<div class="flight ${dClass} ${slotClass}" id="f-${f.id}" 
                    style="width:${f.dur*2}px; left:${f.start*2}px"
                    oncontextmenu="event.preventDefault(); openSlotNegotiation(${idx}, '${f.id}')">
                    <b>${f.route}</b> ${slotBadge}
                </div>`;
            });
            lanes.appendChild(l);
        });
    }

    function openSlotNegotiation(acIdx, fId) {
        const f = fleet[acIdx].flights.find(fl => fl.id == fId);
        if(!f || !f.slot) return;

        const modal = document.getElementById('manifest-modal');
        document.getElementById('m-tail').innerText = `PPS TERMINAL: ${f.route}`;
        
        const sam = `SAM - SLOT ALLOCATION MSG<br>- ID: ${f.id.toString().slice(2,8)}<br>- EOBT: ${formatMins(f.start)}<br>- CTOT: ${formatMins(f.slot.ctot)}<br>- REASON: ATC CAPACITY<br>- STATUS: ${f.ready ? 'READY' : 'NOT READY'}`;

        document.getElementById('m-data').innerHTML = `<div class="pps-msg">${sam}</div>`;
        document.getElementById('m-action').innerHTML = `
            <button class="btn" style="width:100%; background:var(--success); color:black; margin-bottom:5px;" onclick="sendReadyMsg(${acIdx}, '${fId}')">SEND READY MSG (REA)</button>
            <button class="btn" style="width:100%;" onclick="requestImprovement(${acIdx}, '${fId}')">REQUEST SLOT IMPROVEMENT</button>
        `;
        modal.classList.add('active');
    }

    function sendReadyMsg(acIdx, fId) {
        const f = fleet[acIdx].flights.find(fl => fl.id == fId);
        f.ready = true;
        logEvent('PPS', `REA sent for ${f.route}. Aircraft fully boarded and ready.`, 'success');
        closeManifest();
    }

    function requestImprovement(acIdx, fId) {
        const f = fleet[acIdx].flights.find(fl => fl.id == fId);
        if(!f.ready) return alert("Must send READY MSG first!");
        
        if(Math.random() > 0.5) {
            const imp = 15; f.slot.ctot -= imp; f.delay -= imp;
            logEvent('ATC', `SRM received: CTOT improved for ${f.route}`, 'success');
        } else {
            logEvent('ATC', `SJT received: No improvement possible for ${f.route}`, 'warn');
        }
        closeManifest(); renderOCC();
    }

    // --- UTILS ---
    function formatMins(m) {
        return Math.floor(m/60).toString().padStart(2,'0') + ":" + (m%60).toString().padStart(2,'0');
    }

    function logEvent(type, msg, sev) {
        const log = document.getElementById('event-log');
        const color = sev === 'danger' ? 'var(--danger)' : (sev === 'success' ? 'var(--success)' : 'white');
        log.innerHTML = `<div style="color:${color}; margin-bottom:4px;">[${document.getElementById('clock').innerText}] <b>${type}:</b> ${msg}</div>` + log.innerHTML;
    }

    function switchTab(t) {
        document.querySelectorAll('.view-pane, .tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('view-'+t).classList.add('active');
        document.getElementById('btn-'+t).classList.add('active');
    }

    function openManifest(idx) {
        const ac = fleet[idx];
        document.getElementById('m-tail').innerText = ac.tail;
        document.getElementById('m-data').innerHTML = `<p>Base: ${ac.base}<br>Pax: ${ac.pax}</p>`;
        document.getElementById('m-action').innerHTML = '';
        document.getElementById('manifest-modal').classList.add('active');
    }

    function closeManifest() { document.getElementById('manifest-modal').classList.remove('active'); }

    window.onload = () => {
        for(let i=0; i<24; i++) document.getElementById('hours').innerHTML += `<div class="hour">${i}:00</div>`;
        fleet.forEach((ac, i) => {
            const start = 480 + (i*15);
            const f = {id: Math.random(), route: ac.base+'-LPA', start, dur: 310, delay: 0, ready: false};
            if(i % 3 === 0) f.slot = {ctot: start + 45, original: start}; // Add slots to every 3rd plane
            ac.flights.push(f);
        });
        renderOCC();
        setInterval(tick, 1000);
    };
</script>
</body>
</html>
