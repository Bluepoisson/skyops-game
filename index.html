<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkyOps: Nordic Fleet OCC & PDC</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        :root { --bg: #0b0e14; --panel: #1a1f2b; --accent: #00d2ff; --warn: #ff9f43; --danger: #ee5253; --success: #10ac84; --border: #30363d; --pdc-bg: #f1f5f9; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-user-select: none; }
        body { background: var(--bg); color: #cfd8dc; margin: 0; overflow: hidden; }

        /* TABS */
        nav { display: flex; background: #161b22; border-bottom: 1px solid var(--border); height: 45px; }
        .tab-btn { background: transparent; border: none; color: #8b949e; padding: 0 25px; cursor: pointer; font-size: 12px; font-weight: bold; border-right: 1px solid var(--border); }
        .tab-btn.active { background: var(--panel); color: var(--accent); border-bottom: 3px solid var(--accent); }

        /* OCC VIEW */
        .view-pane { display: none; height: calc(100vh - 45px); }
        .view-pane.active { display: grid; }
        #view-occ { grid-template-columns: 1fr 300px; }
        #occ-grid { display: grid; grid-template-columns: 150px 1fr; overflow-y: auto; background: #0d1117; }
        .tail-column { background: var(--panel); border-right: 1px solid var(--border); position: sticky; left: 0; z-index: 20; }
        .tail-cell { height: 160px; border-bottom: 1px solid var(--border); padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .timeline-scroll { position: relative; overflow-x: auto; background: repeating-linear-gradient(90deg, transparent, transparent 119px, #222 120px); width: 2880px; }
        .hour-markers { display: flex; height: 30px; background: #161b22; width: 2880px; position: sticky; top: 0; z-index: 10; }
        .hour { min-width: 120px; border-right: 1px solid #333; font-size: 10px; line-height: 30px; padding-left: 5px; color: #8b949e; }
        .dropzone { height: 160px; border-bottom: 1px solid #222; position: relative; width: 2880px; }
        .flight { position: absolute; height: 60px; top: 20px; background: #238636; border-radius: 4px; color: white; font-size: 10px; padding: 8px; z-index: 5; }
        #time-cursor { position: absolute; top: 0; bottom: 0; width: 2px; background: yellow; z-index: 100; pointer-events: none; box-shadow: 0 0 10px yellow; }

        /* DELAY CLASSES */
        .delay-minor { background: #1e3799 !important; } .delay-moderate { background: #f39c12 !important; color: #000 !important; } .delay-severe { background: #c0392b !important; }

        /* PDC VIEW */
        #view-pdc { grid-template-columns: 200px 1fr 280px; background: var(--pdc-bg); color: #333; }
        .pdc-sidebar { background: #e2e8f0; border-right: 2px solid #cbd5e1; overflow-y: auto; }
        .pdc-main { overflow: auto; background: #fff; }
        .pdc-conflicts { background: #1e293b; color: white; padding: 15px; overflow-y: auto; }
        .pdc-name-row { height: 35px; border-bottom: 1px solid #cbd5e1; padding: 8px; font-size: 11px; font-weight: bold; background: #fff; }
        .pdc-timeline { display: flex; height: 35px; background: #64748b; color: white; position: sticky; top: 0; z-index: 10; width: 5000px; }
        .pdc-day-head { min-width: 60px; border-right: 1px solid #475569; text-align: center; line-height: 35px; }
        .pdc-row { display: flex; height: 35px; border-bottom: 1px solid #e2e8f0; width: 5000px; }
        .pdc-cell { min-width: 60px; border-right: 1px solid #e2e8f0; position: relative; }
        .duty-block { position: absolute; top: 4px; bottom: 4px; left: 2px; right: 2px; border-radius: 2px; font-size: 9px; text-align: center; line-height: 25px; color: white; cursor: grab; font-weight: bold; }
        .duty-fli { background: #2563eb; } .duty-sby { background: #d97706; } .duty-off { background: #94a3b8; } .duty-sick { background: #dc2626; }
        
        /* SIDEBARS & MISC */
        aside { background: var(--panel); padding: 15px; border-left: 1px solid var(--border); overflow-y: auto; color: white; }
        .violation-card { background: rgba(239, 68, 68, 0.15); border-left: 4px solid #ef4444; padding: 10px; margin-bottom: 10px; font-size: 11px; }
        .btn { background: #21262d; border: 1px solid var(--border); color: #fff; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-size: 11px; }
        #manifest-modal { visibility: hidden; opacity: 0; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:999; display:flex; align-items:center; justify-content:center; }
        #manifest-modal.active { visibility: visible; opacity: 1; }
        .m-content { background: var(--panel); color: white; padding: 25px; border-radius: 8px; width: 400px; border: 2px solid var(--accent); }
    </style>
</head>
<body>

<nav>
    <button class="tab-btn active" id="btn-occ" onclick="switchTab('occ')">‚úàÔ∏è OPS CONTROL</button>
    <button class="tab-btn" id="btn-pdc" onclick="switchTab('pdc')">üë• CREW MGMT (PDC)</button>
    <div style="margin-left:auto; display:flex; align-items:center; padding-right:15px; gap:15px; font-size:11px; color:var(--accent);">
        <span>UTC: <b id="clock">07:00</b></span>
        <span>REV: <b id="rev">0</b> DKK</span>
    </div>
</nav>

<div id="view-occ" class="view-pane active">
    <div id="occ-grid">
        <div class="tail-column" id="tails"></div>
        <div class="timeline-scroll">
            <div class="hour-markers" id="hours"></div>
            <div id="lanes"><div id="time-cursor"></div></div>
        </div>
    </div>
    <aside>
        <button class="btn" style="width:100%; border-color:var(--warn);" onclick="undoMove()">‚Ü∫ UNDO ACTION</button>
        <div style="margin-top:20px; font-size:11px; color:var(--warn);">EU261 RISK MONITOR</div>
        <div id="risk-list" style="font-size:10px; margin-top:10px;"></div>
    </aside>
</div>

<div id="view-pdc" class="view-pane">
    <div class="pdc-sidebar" id="pdc-names"></div>
    <div class="pdc-main">
        <div class="pdc-timeline" id="pdc-header"></div>
        <div id="pdc-rows"></div>
    </div>
    <div class="pdc-conflicts">
        <div style="font-size:12px; font-weight:bold; margin-bottom:15px; color:var(--warn);">‚ö†Ô∏è LEGAL VIOLATIONS</div>
        <div id="violation-list"></div>
        <button class="btn" style="width:100%; background:var(--success); margin-top:20px;" onclick="publishRoster()">PUBLISH ROSTER</button>
    </div>
</div>

<div id="manifest-modal" onclick="closeManifest()">
    <div class="m-content" onclick="event.stopPropagation()">
        <h2 id="m-tail" style="margin:0; color:var(--accent);"></h2>
        <div id="m-data" style="margin:15px 0; font-size:13px; line-height:1.6;"></div>
        <div id="m-action"></div>
        <button class="btn" style="width:100%; margin-top:15px;" onclick="closeManifest()">CLOSE</button>
    </div>
</div>

<script>
    // --- DATABASE & STATE ---
    let gameTime = 420; 
    let revenue = 5000000;
    let history = [];
    let fleet = Array.from({length: 14}, (_, i) => ({
        id: i, tail: `OY-GM${String.fromCharCode(65+i)}`,
        base: ['CPH', 'BLL', 'ARN', 'HEL'][i % 4],
        pax: 189, discretion: false, flights: []
    }));

    let crewDatabase = [];
    const DAYS = 31;

    function initCrew() {
        const roles = ["CPT", "FO", "SCCM", "CCM"];
        for(let i=0; i<200; i++) {
            let role = i < 30 ? "CPT" : (i < 60 ? "FO" : (i < 100 ? "SCCM" : "CCM"));
            let roster = [];
            for(let d=1; d<=DAYS; d++) {
                let r = Math.random();
                roster.push(r > 0.8 ? {type:'OFF', code:'OFF'} : (r > 0.6 ? {type:'SBY', code:'SBY'} : {type:'FLI', code:'LPA'}));
            }
            crewDatabase.push({ id: i, name: role + " " + (100+i), role, base: fleet[i%14].base, roster });
        }
    }

    // --- GAME ENGINE ---
    function tick() {
        gameTime++;
        updateClock();
        if(gameTime % 60 === 0) {
            checkEU261();
            if(document.getElementById('view-occ').classList.contains('active')) renderOCC();
        }
    }

    function updateClock() {
        const h = Math.floor(gameTime / 60).toString().padStart(2, '0');
        const m = (gameTime % 60).toString().padStart(2, '0');
        document.getElementById('clock').innerText = `${h}:${m}`;
        document.getElementById('time-cursor').style.left = (gameTime * 2) + 'px';
        document.getElementById('rev').innerText = revenue.toLocaleString();
    }

    // --- OCC LOGIC ---
    function renderOCC() {
        const tails = document.getElementById('tails');
        const lanes = document.getElementById('lanes');
        tails.innerHTML = ''; 
        lanes.innerHTML = '<div id="time-cursor"></div>';

        fleet.forEach((ac, idx) => {
            tails.innerHTML += `<div class="tail-cell" onclick="openManifest(${idx})">
                <b style="color:var(--accent)">${ac.tail}</b><small>${ac.base}</small>
            </div>`;
            const l = document.createElement('div');
            l.className = 'dropzone'; l.dataset.idx = idx;
            ac.flights.forEach(f => {
                let dClass = f.delay > 180 ? 'delay-severe' : (f.delay > 60 ? 'delay-moderate' : (f.delay > 0 ? 'delay-minor' : ''));
                l.innerHTML += `<div class="flight ${dClass}" id="f-${f.id}" style="width:${f.dur*2}px; left:${f.start*2}px">
                    <b>${f.route}</b><br><small>${f.delay > 0 ? '+'+f.delay+'m' : 'ON TIME'}</small>
                </div>`;
            });
            lanes.appendChild(l);
        });
        setupDrag();
    }

    function openManifest(idx) {
        const ac = fleet[idx];
        const reportTime = 420 - 60; 
        const duty = gameTime - reportTime;
        document.getElementById('m-tail').innerText = ac.tail;
        document.getElementById('m-data').innerHTML = `
            <b>Status:</b> ${duty > 720 ? 'LIMIT EXCEEDED' : 'LEGAL'}<br>
            <b>FDP:</b> ${Math.floor(duty/60)}h ${duty%60}m / 12h<br>
            <b>Pax:</b> ${ac.pax}<br>
            <b>Base:</b> ${ac.base}
        `;
        document.getElementById('m-action').innerHTML = (duty > 720 && duty < 840 && !ac.discretion) ? 
            `<button class="btn" style="width:100%; background:var(--warn); color:black;" onclick="invokeDiscretion(${idx})">INVOKE COMMANDER'S DISCRETION</button>` : '';
        document.getElementById('manifest-modal').classList.add('active');
    }

    function invokeDiscretion(idx) {
        saveState();
        fleet[idx].discretion = true;
        revenue -= 35000; // Administrative penalty in DKK
        closeManifest(); renderOCC();
    }

    function checkEU261() {
        fleet.forEach(ac => {
            ac.flights.forEach(f => {
                if(f.delay >= 180 && !f.paid) {
                    let fine = f.dur > 300 ? 4475 : 2985;
                    revenue -= (fine * ac.pax);
                    f.paid = true;
                }
            });
        });
    }

    // --- PDC LOGIC ---
    let dragged = null;
    function switchTab(t) {
        document.querySelectorAll('.view-pane, .tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('view-'+t).classList.add('active');
        document.getElementById('btn-'+t).classList.add('active');
        if(t === 'pdc') renderPDC();
    }

    function renderPDC() {
        const names = document.getElementById('pdc-names');
        const header = document.getElementById('pdc-header');
        const rows = document.getElementById('pdc-rows');
        
        names.innerHTML = ''; header.innerHTML = ''; rows.innerHTML = '';
        for(let d=1; d<=DAYS; d++) header.innerHTML += `<div class="pdc-day-head">${d}</div>`;

        crewDatabase.forEach(crew => {
            names.innerHTML += `<div class="pdc-name-row">${crew.name}</div>`;
            const r = document.createElement('div');
            r.className = 'pdc-row';
            crew.roster.forEach((duty, dIdx) => {
                const c = document.createElement('div');
                c.className = 'pdc-cell';
                c.innerHTML = `<div class="duty-block duty-${duty.type.toLowerCase()}" draggable="true" ondragstart="pdcDrag(event, ${crew.id}, ${dIdx})">${duty.code}</div>`;
                c.ondragover = e => e.preventDefault();
                c.ondrop = e => pdcDrop(e, crew.id, dIdx);
                r.appendChild(c);
            });
            rows.appendChild(r);
        });
        validatePDC();
    }

    function pdcDrag(e, cid, did) { dragged = { cid, did }; }
    function pdcDrop(e, tcid, tdid) {
        saveState();
        const sCrew = crewDatabase.find(c => c.id === dragged.cid);
        const tCrew = crewDatabase.find(c => c.id === tcid);
        if(sCrew.role !== tCrew.role) return alert("Role Mismatch!");
        
        const temp = sCrew.roster[dragged.did];
        sCrew.roster[dragged.did] = tCrew.roster[tdid];
        tCrew.roster[tdid] = temp;
        renderPDC();
    }

    function validatePDC() {
        const list = document.getElementById('violation-list');
        list.innerHTML = '';
        crewDatabase.forEach(c => {
            let consecutive = 0;
            c.roster.forEach(d => {
                if(d.type !== 'OFF') consecutive++;
                else consecutive = 0;
                if(consecutive > 6) {
                    list.innerHTML += `<div class="violation-card"><b>7-Day Rule</b>${c.name} has exceeded 6 consecutive days.</div>`;
                }
            });
        });
    }

    // --- SYSTEM ---
    function saveState() {
        history.push(JSON.parse(JSON.stringify({fleet, revenue, crewDatabase})));
        if(history.length > 20) history.shift();
    }
    function undoMove() {
        if(!history.length) return;
        const s = history.pop();
        fleet = s.fleet; revenue = s.revenue; crewDatabase = s.crewDatabase;
        renderOCC();
    }
    function closeManifest() { document.getElementById('manifest-modal').classList.remove('active'); }

    window.onload = () => {
        for(let i=0; i<24; i++) document.getElementById('hours').innerHTML += `<div class="hour">${i}:00</div>`;
        initCrew();
        // Generate Start Schedule
        fleet.forEach((ac, i) => {
            let dur = ac.tail === 'OY-GMA' ? 350 : 310;
            ac.flights.push({id: Math.random(), route: ac.base+'-LPA', start: 420+(i*10), dur: dur, delay: i==0?190:0});
        });
        renderOCC();
        setInterval(tick, 1000);
    };
</script>
</body>
</html>
